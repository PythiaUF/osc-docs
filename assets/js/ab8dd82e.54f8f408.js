"use strict";(self.webpackChunkosc_docs=self.webpackChunkosc_docs||[]).push([[5160],{3905:(e,n,t)=>{t.d(n,{Zo:()=>p,kt:()=>g});var o=t(7294);function s(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);n&&(o=o.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,o)}return t}function i(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){s(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function r(e,n){if(null==e)return{};var t,o,s=function(e,n){if(null==e)return{};var t,o,s={},a=Object.keys(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||(s[t]=e[t]);return s}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(o=0;o<a.length;o++)t=a[o],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(s[t]=e[t])}return s}var l=o.createContext({}),c=function(e){var n=o.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):i(i({},n),e)),t},p=function(e){var n=c(e.components);return o.createElement(l.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return o.createElement(o.Fragment,{},n)}},m=o.forwardRef((function(e,n){var t=e.components,s=e.mdxType,a=e.originalType,l=e.parentName,p=r(e,["components","mdxType","originalType","parentName"]),u=c(t),m=s,g=u["".concat(l,".").concat(m)]||u[m]||d[m]||a;return t?o.createElement(g,i(i({ref:n},p),{},{components:t})):o.createElement(g,i({ref:n},p))}));function g(e,n){var t=arguments,s=n&&n.mdxType;if("string"==typeof e||s){var a=t.length,i=new Array(a);i[0]=m;var r={};for(var l in n)hasOwnProperty.call(n,l)&&(r[l]=n[l]);r.originalType=e,r[u]="string"==typeof e?e:s,i[1]=r;for(var c=2;c<a;c++)i[c]=t[c];return o.createElement.apply(null,i)}return o.createElement.apply(null,t)}m.displayName="MDXCreateElement"},4829:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var o=t(7462),s=(t(7294),t(3905));const a={title:"Deploying to Kubernetes",description:"Club Website Developer Kubernetes guide",sidebar_position:9},i="Deploying to Kubernetes",r={unversionedId:"Developers/kubernetes",id:"Developers/kubernetes",title:"Deploying to Kubernetes",description:"Club Website Developer Kubernetes guide",source:"@site/docs/website/Developers/kubernetes.md",sourceDirName:"Developers",slug:"/Developers/kubernetes",permalink:"/docs/website/Developers/kubernetes",draft:!1,editUrl:"https://github.com/ufosc/osc-docs/blob/main/docs/website/Developers/kubernetes.md",tags:[],version:"current",sidebarPosition:9,frontMatter:{title:"Deploying to Kubernetes",description:"Club Website Developer Kubernetes guide",sidebar_position:9},sidebar:"defaultSidebar",previous:{title:"Testing & Linting",permalink:"/docs/website/Developers/testing"},next:{title:"Contributing Guide",permalink:"/docs/website/Developers/contributing-guide"}},l={},c=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Building the Docker image",id:"building-the-docker-image",level:2},{value:"Configuring Kubernetes",id:"configuring-kubernetes",level:2},{value:"Applying the YAML configuration",id:"applying-the-yaml-configuration",level:3},{value:"GKE-specific resources",id:"gke-specific-resources",level:3},{value:"Static IP",id:"static-ip",level:4},{value:"SSL Ingress Policy",id:"ssl-ingress-policy",level:4},{value:"Creating an Admin",id:"creating-an-admin",level:2}],p={toc:c},u="wrapper";function d(e){let{components:n,...t}=e;return(0,s.kt)(u,(0,o.Z)({},p,t,{components:n,mdxType:"MDXLayout"}),(0,s.kt)("h1",{id:"deploying-to-kubernetes"},"Deploying to Kubernetes"),(0,s.kt)("p",null,"Kubernetes, often abbreviated as K8s, is an open-source container orchestration platform used for automating the deployment, scaling, and management of containerized applications. With Kubernetes, you can set up a configuration file that automatically deploys the website's infrastructure in seconds."),(0,s.kt)("p",null,"Kubernetes is based on Docker, an open-source platform and a set of tools for creating, deploying, and managing containerized applications. To deploy the website on Kubernetes, you'll first need to build the website's container image."),(0,s.kt)("h2",{id:"prerequisites"},"Prerequisites"),(0,s.kt)("ol",null,(0,s.kt)("li",{parentName:"ol"},"Complete the ",(0,s.kt)("a",{parentName:"li",href:"/docs/website/Developers/introduction"},"Getting Started")," guide."),(0,s.kt)("li",{parentName:"ol"},(0,s.kt)("a",{parentName:"li",href:"https://www.docker.com/"},"Docker"),": build the website container image."),(0,s.kt)("li",{parentName:"ol"},"Kubernetes Cluster & Kubectl: Use a cloud hosting platform or ",(0,s.kt)("a",{parentName:"li",href:"https://docs.docker.com/desktop/kubernetes/"},"launch a Kubernetes node on Docker"),".")),(0,s.kt)("h2",{id:"building-the-docker-image"},"Building the Docker image"),(0,s.kt)("admonition",{title:"Artifact Registry",type:"danger"},(0,s.kt)("p",{parentName:"admonition"},"If you're using a SaaS/cloud solution, you'll need to upload the container image to your project's artifact registry.")),(0,s.kt)("p",null,"Navigate to the source directory"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"cd Club_Website_2\n")),(0,s.kt)("p",null,"Run docker build:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"docker build --tag osc-website .\n")),(0,s.kt)("h2",{id:"configuring-kubernetes"},"Configuring Kubernetes"),(0,s.kt)("p",null,"You can deploy containers on Kubernetes using yaml files. Yaml is a file format similar to JSON, you can read more about it ",(0,s.kt)("a",{parentName:"p",href:"https://www.educative.io/blog/yaml-tutorial"},"here"),". The website YAML file is documented below."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yml"},'apiVersion: v1\nkind: Secret\n# The secrets here correspond to the website\'s environment variables.\n# These are documented at https://docs.ufosc.org/docs/website/Developers/configuration\ndata:\n  secret:    [YOU-SECRET-HERE]\n  smtp-user: [YOUR-SMTP-USER]\n  smtp-pass: [YOUR-SMPT-PASS]\n  captcha:   [YOUR-CAPTCHA-KEY] # Optional\n  email:     [YOUR-CONTACT-FORM-EMAIL]\nmetadata:\n  name: osc-website-secrets\n  labels:\n    app: osc-website\n---\n# A volume is a persistent store of data.\n# This is the volume for the website database.\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: osc-website-volume-db\n  labels:\n    app: osc-website\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      # The amount of persistent storage to allocate.\n      storage: 1Gi\n---\n# A volume is a persistent store of data.\n# This is the volume for storing image uploads.\napiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: osc-website-volume-uploads\n  labels:\n    app: osc-website\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      # The amount of persistent storage to allocate.\n      storage: 1Gi\n---\n# A deployment provides a declarative way to describe the desired state of\n# an application. In this case, the desired state is to have at least 1\n# replica of Mongodb and the OSC Website running on the node.\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: osc-website\n  labels:\n    app: osc-website\nspec:\n  # The replicas property specifies how many copies of this deployment\n  # to try to launch. Generally, more replicas mean the app scales to\n  # more users.\n  replicas: 1\n  selector:\n    matchLabels:\n      app: osc-website\n  template:\n    metadata:\n      labels:\n        app: osc-website\n    spec:\n      containers:\n        - name: mongodb\n          image: mongo\n          args: ["--dbpath", "/data/db"]\n          volumeMounts:\n            - name: osc-website-volume-db\n              mountPath: "/data/db/"\n        - name: club-website\n          # If you\'re using a cloud provider, you\'ll need to modify the image\n          # name to reference your artifact registry.\n          image: club-website:latest\n          # Environment variable configurations, as documented here:\n          # https://docs.ufosc.org/docs/website/Developers/configuration\n          env:\n            - name: MONGO_URI\n              value: "mongodb://127.0.0.1:27017"\n            - name: NODE_ENV\n              value: "production"\n            - name: RATE_LIMIT_MAX\n              value: "150"\n            - name: RATE_LIMIT_TIMEOUT\n              value: "1"\n            - name: SECRET\n              valueFrom:\n                secretKeyRef:\n                  name: osc-website-secrets\n                  key: secret\n            - name: SMTP_USER\n              valueFrom:\n                secretKeyRef:\n                  name: osc-website-secrets\n                  key: smtp-user\n            - name: SMTP_PASS\n              valueFrom:\n                secretKeyRef:\n                  name: osc-website-secrets\n                  key: smtp-pass\n            - name: ADMIN_EMAIL\n              valueFrom:\n                secretKeyRef:\n                  name: osc-website-secrets\n                  key: email\n            - name: CACHE_INTERVAL\n              value: "480"\n            - name: CAPTCHA_SECRET\n              valueFrom:\n                secretKeyRef:\n                  name: osc-website-secrets\n                  key: captcha\n          volumeMounts:\n            - name: osc-website-volume-uploads\n              mountPath: "/ufosc/app/uploads/"\n      volumes:\n        - name: osc-website-volume-db\n        - name: osc-website-volume-uploads\n---\n# A service exposes the 3002 port (default website port) of the osc-website\n# deployment. If you\'re running Kubernetes locally and you specify a nodePort,\n# the website will be accessible at http://localhost:nodePort.\napiVersion: v1\nkind: Service\nmetadata:\n  name: osc-website-service\n  labels:\n    app: osc-website\nspec:\n  type: NodePort\n  selector:\n    app: osc-website\n  ports:\n    - protocol: TCP\n      port: 3002\n      targetPort: 3002\n      # nodePort: 30000\n---\n# An ingress redirects traffic from your cluster\'s endpoint to\n# port 3002 of the website deployment. It is generally not required\n# in locally hosted environments.\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: osc-website-ingress\n  labels:\n    app: osc-website\nspec:\n  defaultBackend:\n    service:\n      name: osc-website-service\n      port:\n        number: 3002\n')),(0,s.kt)("h3",{id:"applying-the-yaml-configuration"},"Applying the YAML configuration"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl apply -f your_file.yml\n")),(0,s.kt)("p",null,"If you're using a cloud platform, ensure that kubectl is configured to target your remote cluster."),(0,s.kt)("h3",{id:"gke-specific-resources"},"GKE-specific resources"),(0,s.kt)("admonition",{title:"GKE Only",type:"danger"},(0,s.kt)("p",{parentName:"admonition"},"These options only apply to clusters managed by Google Kubernetes Engine (GKE).")),(0,s.kt)("p",null,"Additional resources for Google Kubernetes engine."),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-yml"},'# The ManagedCertificate resource instructs Google Cloud to\n# generate and sign an SSL certificate for the specified domains.\napiVersion: networking.gke.io/v1\nkind: ManagedCertificate\nmetadata:\n  name: osc-website-cert\n  labels:\n    app: osc-website\nspec:\n  domains:\n    - ufosc.org\n---\n# The GKE FrontendConfig is configured to redirect non-HTTPS\n# traffic to the HTTPS endpoint.\napiVersion: networking.gke.io/v1beta1\nkind: FrontendConfig\nmetadata:\n name: osc-website-fe-config\nspec:\n  sslPolicy: gke-ingress-ssl-policy\n  redirectToHttps:\n    enabled: true\n---\n# Same as before, but metadata.annotations specifies which\n# Google ingress controller, static IP, and certificate to\n# deploy the site with.\napiVersion: networking.k8s.io/v1\nkind: Ingress\nmetadata:\n  name: osc-website-ingress\n  labels:\n    app: osc-website\n  annotations:\n    kubernetes.io/ingress.class: "gce"\n    kubernetes.io/ingress.global-static-ip-name: oscwebsite\n    networking.gke.io/managed-certificates: osc-website-cert\n    networking.gke.io/v1beta1.FrontendConfig: osc-website-fe-config\nspec:\n  defaultBackend:\n    service:\n      name: osc-website-service\n      port:\n        number: 3002\n')),(0,s.kt)("h4",{id:"static-ip"},"Static IP"),(0,s.kt)("p",null,"The configuration above requires registering a static IP address. A static IP address makes deployment considerably easier, since the website won't have to be exposed on (volatile) node IP addresses."),(0,s.kt)("p",null,"See Google's documentation ",(0,s.kt)("a",{parentName:"p",href:"https://cloud.google.com/compute/docs/ip-addresses/reserve-static-external-ip-address"},"here"),"."),(0,s.kt)("h4",{id:"ssl-ingress-policy"},"SSL Ingress Policy"),(0,s.kt)("p",null,"Additionally, the GKE configuration depends on a registered SSL ingress policy. SSL policies specify the set of SSL features that Google Cloud load balancers use when negotiating SSL with clients."),(0,s.kt)("p",null,"See Google's documentation ",(0,s.kt)("a",{parentName:"p",href:"https://cloud.google.com/load-balancing/docs/use-ssl-policies"},"here"),"."),(0,s.kt)("h2",{id:"creating-an-admin"},"Creating an Admin"),(0,s.kt)("p",null,"The Kubernetes config sets up the website with an empty database, which makes logging in to the site is impossible. This is solved by connecting to the Mongo container and calling mongosh to add the first user. This process should only be done once, additional admins can be added through the ",(0,s.kt)("a",{parentName:"p",href:"/docs/website/admin"},"admin dashboard"),"."),(0,s.kt)("p",null,"First, get a list of all pods"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl get pods\n")),(0,s.kt)("p",null,"The command should respond with something like this:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"NAME                          READY   STATUS    RESTARTS   AGE\nosc-website-c5986c5ff-zdbxk   2/2     Running   0          4h55m\n")),(0,s.kt)("p",null,"You'll be connecting to one of the pods specified by the output of the ",(0,s.kt)("inlineCode",{parentName:"p"},"kubectl get pods")," command. Note down one of the pod names assosciated with the osc-website deployment (if you have multiple replicas, you can choose any pod just as long as its part of the osc-website deployment resource)."),(0,s.kt)("p",null,"Connect using the following command (replace ","[YOUR-POD-NAME-HERE]"," with the pod name from above):"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"kubectl exec --stdin --tty [YOUR-POD-NAME-HERE] -- /bin/bash\n")),(0,s.kt)("p",null,"Once connected, open the mongosh console by typing ",(0,s.kt)("inlineCode",{parentName:"p"},"mongosh"),". Then, paste the following:"),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},"use test\n")),(0,s.kt)("pre",null,(0,s.kt)("code",{parentName:"pre",className:"language-bash"},'db.users.insertOne({"username": "admin","password": {"hash": "\ufffda2O\ufffd\ufffd\ufffdw\ufffd\ufffd\\u0004\ufffd\ufffd\u0232\ufffd\ufffd7\\u000fM\ufffd2\\u0011\ufffd<\\u0015z\\u0016\\u0019E*\ufffd\ufffdc\u042e\\u0010\\u001e\\u0015\ufffd\ufffd\ufffd\u0582)\ufffdNe\ufffd\ufffdG\ufffdVH/\ufffd\ufffd9\ufffd\ufffd\ufffd\ufffd\ufffdq\\u0003\ufffd\\t\ufffd\ufffd\u05e4}\ufffd\ufffd\ufffdi\ufffd\ufffdY\ufffd\\u00125\ufffd\ufffdd3\ufffdV\ufffd\\t6\ufffd\ufffd\ufffd\ufffd\ufffd\ufffdW;\ufffd~\ufffd\ufffd\ufffd?A\ufffd\ufffd\\u001c\ufffd\ufffdX8\ufffd\ufffd/\\u0012\ufffd\ufffd\\u0007)t\ufffd\ufffd9\\u0001<","salt": "4vRF0ZTMELWmPGMpAgy6hsiJm/pOUlgPYFk+faK+yaFv/x0+lITG+4kX/y5bXudjMdGWLN2PV8UhH5s5dRLPaGgh2qwrbocDqEdyvbqSqVPAQxKIwFSytoRySYfKZJdCgK970UmrPDyGmoAIRZ/DN8YZ4fTirkSAeRlTWLSbyfg="},"fullName": "admin","role": "admin","isAdmin": true,"date": {"$date": "2023-09-17T15:53:18.529Z"},"__v": 0})\n')),(0,s.kt)("p",null,"The command above adds a user with the username ",(0,s.kt)("inlineCode",{parentName:"p"},"admin")," and password ",(0,s.kt)("inlineCode",{parentName:"p"},"123456"),". You should now reset the admin's password using the ",(0,s.kt)("a",{parentName:"p",href:"/docs/website/admin"},"admin dashboard")," as soon as possible to prevent attackers from logging in with the default credentials. Resetting the password through the admin dashboard should reset the password salt as well."),(0,s.kt)("p",null,"Finally, type ",(0,s.kt)("inlineCode",{parentName:"p"},"exit")," and press enter to exit the mongosh console. Type ",(0,s.kt)("inlineCode",{parentName:"p"},"exit")," and press enter once again to close the connection to the pod."))}d.isMDXComponent=!0}}]);